<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
<title>Brand Risk Dashboard</title>

<!-- Chart.js + PapaParse + Annotation Plugin CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
// DATA CONFIGURATION - Uses Cloud Run proxy for authenticated access
// The proxy endpoints in app.py fetch from private GCS bucket
function getDataUrl(path) {
  // Route to appropriate proxy endpoint based on path
  if (path.startsWith('data/')) {
    // /api/data/daily_counts/..., /api/data/processed_articles/..., etc.
    return '/api/data/' + path.substring(5);
  } else if (path.startsWith('rosters/')) {
    // /api/data/rosters/main-roster.csv
    return '/api/data/' + path;
  }
  return '/api/data/' + path;
}
</script>

<style>
:root{
  --bg:#044152; --card:#092e37; --muted:#a2ebf3; --text:#ebf2f2; --accent:#58dbed; --black:#1f2121;
  --pill-neg:#ff8261; --pill-neu:#cfdbdd; --pill-pos:#82c618;
  --stroke:#0e2230; --chip:#12343e; --chipBorder:#174550;
  --stock-pos:#82c616; --stock-neg:#ff8261;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.wrap{max-width:1200px;margin:0 auto;padding:20px}
h1{font-size:28px;margin:6px 0 18px}

/* Controls */
.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:0 0 16px}
.card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:12px}
select,input[type="text"]{background:var(--black);border:1px solid #23314d;border-radius:10px;color:var(--text);padding:8px 10px}
button{background:var(--black);border:1px solid #2a3b5e;color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
button:hover{filter:brightness(1.08)}

/* Charts grid ‚Äì equal heights, responsive */
.grid{
  display:grid;
  grid-template-rows:minmax(360px,42vh) minmax(360px,42vh);
  gap:16px;
  margin:16px 0;
}

/* Chart cards */
.chart-card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:12px 12px 48px;position:relative}
.chart-card canvas{width:100% !important;height:100% !important;display:block}

/* Chart pagination controls (top-right) */
.chart-actions{
  position:absolute;
  top:10px; right:12px;
  display:flex; align-items:center; gap:10px;
}
.chart-actions .dates-range{ font-size:12px; }
.chart-actions .dates-pager{ display:flex; gap:6px; }
.chart-actions .dates-pager button{
  background:#1f2121; border:1px solid #2a3b5e; color:var(--text);
  border-radius:8px; padding:4px 8px; cursor:pointer;
}
.chart-actions .dates-pager button[disabled]{ opacity:.45; cursor:not-allowed; }

/* Table */
.table-card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:10px}
.table-hint{margin:0 0 8px;color:var(--muted)}
.load-status{margin-top:10px;width:100%;display:flex;flex-direction:column;align-items:center}
.load-bar{height:6px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
.load-bar-fill{height:100%;width:0%;background:var(--accent);transition:width .2s ease}
.load-items{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;font-size:12px;color:var(--muted);justify-content:center;text-align:center}
.load-pill{padding:2px 8px;border-radius:999px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.1)}
.load-pill.done{color:#82c618;border-color:rgba(130,198,24,.35);background:rgba(130,198,24,.1)}
.load-pill.error{color:#ff8261;border-color:rgba(255,130,97,.35);background:rgba(255,130,97,.1)}
.table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
.table-scroll::-webkit-scrollbar{height:8px}
.table-scroll::-webkit-scrollbar-track{background:rgba(255,255,255,.05);border-radius:8px}
.table-scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:8px}

table{width:100%;border-collapse:separate;border-spacing:0 6px;table-layout:auto}
thead th{font-size:11px;color:var(--muted);text-align:center;padding:6px 6px;vertical-align:middle;line-height:1.2;white-space:nowrap}
thead th:first-child{white-space:normal;min-width:140px}
tbody td{padding:8px 6px;background:var(--black);border-top:1px solid #0f1831;border-bottom:1px solid #0f1831;text-align:center;white-space:nowrap}
tbody td:first-child{text-align:left;white-space:normal}
tbody tr{transition:background-color 0.15s}
tbody tr:hover{background:rgba(88,219,237,.08)}
tbody tr td:first-child{border-left:1px solid #0f1831;border-radius:10px 0 0 10px}
tbody tr td:last-child{border-right:1px solid #0f1831;border-radius:0 10px 10px 0}

/* Brand column styling with flexbox */
.brand-cell-content{display:flex;align-items:center;gap:8px}
.brand-name{font-weight:500}

/* Stock styling */
.stock-price{font-family:'Courier New',monospace;font-weight:500;color:var(--text)}
.stock-change{font-weight:600}
.stock-change.positive{color:var(--stock-pos)}
.stock-change.negative{color:var(--stock-neg)}

/* Sparkline */
.sparkline-cell{text-align:center;padding:6px 8px !important;cursor:pointer}
.sparkline-cell:hover{background:rgba(88,219,237,.15)}
.sparkline{display:inline-block;vertical-align:middle}

.pill{font-size:12px;border-radius:999px;padding:3px 8px;border:1px solid var(--chipBorder);background:var(--chip);color:#cfe0ff}
.pill.low{background:rgba(130,198,24,.15);color:#82c618}
.pill.med{background:rgba(207,219,221,.25);color:#cfdbdd}
.pill.high{background:rgba(255,130,97,.15);color:#ff8261}
.link{color:var(--accent);text-decoration:underline}

@media (max-width:960px){
  .table-card{padding:8px}
  .table-hint{font-size:12px}
  thead th,tbody td{padding:6px 4px}
  .pill{font-size:11px}
}

/* Tooltips */
.tooltip-header {
  position: relative;
  display: inline-block;
  border-bottom: 1px dotted #a2ebf3;
  cursor: help;
}

.tooltip-header .tooltip-text {
  visibility: hidden;
  width: 240px;
  background-color: #1f2121;
  color: #ebf2f2;
  text-align: left;
  border: 1px solid #2a3b5e;
  border-radius: 8px;
  padding: 10px 12px;
  position: absolute;
  z-index: 1000;
  top: 125%;
  left: 50%;
  margin-left: -120px;
  opacity: 0;
  transition: opacity 0.3s ease;
  font-size: 12px;
  line-height: 1.5;
  font-weight: normal;
  white-space: normal;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
}

.tooltip-header .tooltip-text::after {
  content: "";
  position: absolute;
  bottom: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: transparent transparent #1f2121 transparent;
}

.tooltip-header:hover .tooltip-text {
  visibility: visible;
  opacity: 1;
}

@media (max-width: 768px) {
  .tooltip-header .tooltip-text {
    width: 200px;
    margin-left: -100px;
    font-size: 11px;
  }
}

/* Sticky first column (Company + checkbox) */
thead th:first-child, tbody td:first-child{
  position:sticky;left:0;z-index:2;box-shadow:2px 0 0 0 rgba(255,255,255,.06);
  background:var(--card);
}
tbody td:first-child{background:var(--black)}

/* Pagination */
.pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}

/* Modal (z-index > sticky) */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:24px;z-index:10000}
.modal.open{display:flex}
.modal .box{max-width:900px;width:100%;max-height:85vh;overflow:auto;background:#0e152a;border:1px solid #1b2745;border-radius:16px;position:relative;z-index:10001}
.modal header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #12203d}
.modal header h3{margin:0;font-size:16px}
.modal .content{padding:16px}
.close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer;line-height:20px}
.close:hover,.close:focus{color:var(--text)}
.badges{display:flex;gap:8px;margin-top:8px}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid transparent}
.badge.positive{background:rgba(130,198,24,.15);color:#82c618;border-color:rgba(130,198,24,.35)}
.badge.neutral{background:rgba(207,219,221,.25);color:#cfdbdd;border-color:rgba(207,219,221,.45)}
.badge.negative{background:rgba(255,130,97,.15);color:#ff8261;border-color:rgba(255,130,97,.35)}
.badge.controlled{background:rgba(88,219,237,.15);color:#58dbed;border-color:rgba(88,219,237,.35)}
.badge.uncontrolled{background:rgba(255,130,97,.15);color:#ff8261;border-color:rgba(255,130,97,.35)}
.muted{color:var(--muted)}

/* Stock chart modal */
#stockChartModal .box{max-width:1000px}
#stockChart{width:100%;height:400px}

/* SERP cards */
.serp-cards{display:grid;gap:12px;margin-top:12px}
.serp-card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:14px 16px}
.serp-domain{font-size:12px;color:var(--muted);margin-bottom:4px}
.serp-title a{color:var(--text);text-decoration:underline}
.serp-snippet{color:var(--muted);margin-top:6px;line-height:1.35}
.serp-metrics{margin:4px 0 0;color:var(--muted)}
.serp-metrics b{color:var(--text)}

/* ===== UPDATED: RESPONSIVE NEGATIVE ARTICLES HEATMAP STYLES ===== */

/* Enhanced stock chart modal with responsive sizing */
#stockChartModal .box {
  max-width: 1000px;
  width: 95%;
  max-height: 90vh;
  overflow: auto;
}

/* Responsive chart sizing */
#stockChart {
  width: 100% !important;
  height: 450px !important;
  min-height: 400px;
}

/* Stock modal header - responsive font sizing */
#stockChartModal header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 18px;
  border-bottom: 1px solid #12203d;
  gap: 12px;
}

#stockChartModal header h3 {
  margin: 0;
  font-size: 16px;
  line-height: 1.3;
  flex: 1;
  padding-right: 12px;
}

/* Volume toggle button */
.volume-toggle {
  background: rgba(88, 219, 237, 0.15);
  border: 1px solid rgba(88, 219, 237, 0.3);
  color: var(--accent);
  border-radius: 8px;
  padding: 6px 12px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
  font-weight: 500;
}

.volume-toggle:hover {
  background: rgba(88, 219, 237, 0.25);
  border-color: rgba(88, 219, 237, 0.5);
  transform: translateY(-1px);
}

.volume-toggle.active {
  background: var(--accent);
  color: var(--black);
  border-color: var(--accent);
}

.volume-toggle.active:hover {
  background: #6de5f5;
  border-color: #6de5f5;
}

/* Trends toggle button */
.trends-toggle {
  background: rgba(168, 85, 247, 0.15);
  border: 1px solid rgba(168, 85, 247, 0.3);
  color: #a855f7;
  border-radius: 8px;
  padding: 6px 12px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
  font-weight: 500;
}

.trends-toggle:hover {
  background: rgba(168, 85, 247, 0.25);
  border-color: rgba(168, 85, 247, 0.5);
  transform: translateY(-1px);
}

.trends-toggle.active {
  background: #a855f7;
  color: white;
  border-color: #a855f7;
}

.trends-toggle.active:hover {
  background: #b975f7;
  border-color: #b975f7;
}


#stockChartModal .content {
  padding: 18px;
}

/* Sparkline hover effect - make it more obvious it's clickable */
.sparkline-cell {
  cursor: pointer;
  transition: background-color 0.2s ease;
  position: relative;
}

.sparkline-cell:hover {
  background: rgba(88, 219, 237, 0.2) !important;
}

.sparkline-cell::after {
  content: '';
  position: absolute;
  inset: 0;
  border: 2px solid transparent;
  border-radius: 8px;
  pointer-events: none;
  transition: border-color 0.2s ease;
}

.sparkline-cell:hover::after {
  border-color: rgba(88, 219, 237, 0.4);
}

.sparkline-cell:hover .sparkline {
  filter: brightness(1.2);
}

/* Loading state for stock chart */
.stock-chart-loading {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 400px;
  color: var(--muted);
  font-size: 14px;
}

.stock-chart-loading::before {
  content: 'üìä';
  font-size: 32px;
  margin-right: 12px;
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 0.5; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.1); }
}

/* Add subtle animation when chart loads */
@keyframes chartFadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

#stockChart {
  animation: chartFadeIn 0.3s ease-out;
}

/* Enhanced close button for stock modal */
#stockChartModal .close {
  transition: all 0.2s ease;
  cursor: pointer;
  user-select: none;
  font-size: 32px;
  line-height: 28px;
  font-weight: 300;
  padding: 0 4px;
  margin: -4px 0;
}

#stockChartModal .close:hover {
  color: var(--accent) !important;
  transform: scale(1.15);
}

#stockChartModal .close:active {
  transform: scale(0.95);
}

/* Better visual feedback for the sparkline */
.sparkline {
  transition: opacity 0.2s ease;
}

.sparkline-cell:active .sparkline {
  opacity: 0.7;
}

/* ===== TABLET RESPONSIVENESS (768px - 1024px) ===== */
@media (max-width: 1024px) {
  #stockChartModal .box {
    width: 92%;
    max-width: 900px;
  }
  
  #stockChart {
    height: 420px !important;
    min-height: 380px;
  }
  
  #stockChartModal header h3 {
    font-size: 15px;
  }
  
  #stockChartModal .content {
    padding: 16px;
  }
}

/* ===== MOBILE RESPONSIVENESS (< 768px) ===== */
@media (max-width: 768px) {
  /* Full-screen modal on mobile */
  #stockChartModal .box {
    width: 100%;
    height: 100%;
    max-width: 100%;
    max-height: 100vh;
    margin: 0;
    border-radius: 0;
    display: flex;
    flex-direction: column;
  }
  
  #stockChartModal header {
    padding: 12px 16px;
    flex-shrink: 0;
  }
  
  #stockChartModal header h3 {
    font-size: 14px;
    line-height: 1.4;
  }
  
  #stockChartModal .close {
    font-size: 28px;
    line-height: 24px;
  }
  
  /* Scrollable content area */
  #stockChartModal .content {
    padding: 12px 16px 16px;
    overflow-y: auto;
    flex: 1;
    -webkit-overflow-scrolling: touch;
  }
  
  /* Optimized chart height for mobile */
  #stockChart {
    height: 350px !important;
    min-height: 300px;
    max-height: 60vh;
  }
  
  /* Touch-friendly close button */
  #stockChartModal .close {
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
}

/* ===== SMALL MOBILE (< 480px) ===== */
@media (max-width: 480px) {
  #stockChartModal header h3 {
    font-size: 13px;
  }
  
  #stockChart {
    height: 320px !important;
    min-height: 280px;
  }
  
  #stockChartModal .content {
    padding: 10px 12px 14px;
  }
}

/* ===== LANDSCAPE MOBILE ===== */
@media (max-width: 768px) and (orientation: landscape) {
  #stockChart {
    height: 70vh !important;
    min-height: 250px;
  }
}

/* ===== LARGE SCREENS (> 1400px) ===== */
@media (min-width: 1400px) {
  #stockChartModal .box {
    max-width: 1200px;
  }
  
  #stockChart {
    height: 500px !important;
  }
  
  #stockChartModal header h3 {
    font-size: 18px;
  }
}

/* Prevent body scroll when modal is open on mobile */
body:has(#stockChartModal.open) {
  overflow: hidden;
}

/* Better touch targets for mobile */
@media (max-width: 768px) {
  .sparkline-cell {
    padding: 10px 8px !important;
  }
  
  button {
    min-height: 44px;
    padding: 10px 14px;
  }
}

/* Optional: Add a subtle overlay background blur on larger screens */
@media (min-width: 769px) {
  #stockChartModal {
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
  }
}

/* ===== ENHANCED HEATMAP LEGEND STYLES ===== */
.heatmap-legend {
  display: flex;
  gap: 18px;
  align-items: center;
  justify-content: center;
  padding: 10px 16px;
  background: rgba(30, 40, 55, 0.7);
  border: 1px solid rgba(88, 219, 237, 0.2);
  border-radius: 8px;
  margin-top: 14px;
  font-size: 13px;
  font-weight: 500;
  flex-wrap: wrap;
  color: #e3f2f7;
}

.heatmap-legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.heatmap-legend-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid #fff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  flex-shrink: 0;
}

.heatmap-legend-dot.medium {
  background: #ffaa44;
}

.heatmap-legend-dot.high {
  background: #ff4444;
}

@media (max-width: 768px) {
  .heatmap-legend {
    font-size: 12px;
    gap: 14px;
    padding: 8px 12px;
  }
  
  .heatmap-legend-dot {
    width: 10px;
    height: 10px;
  }
}


</style>
</head>

<body>
<div class="wrap">
  <h1>Brand Risk Dashboard</h1>

  <div class="controls card">
    <div>
      <div class="muted" style="font-size:12px;margin:0 0 4px">Date</div>
      <select id="dateSelect"></select>
    </div>
    <div style="flex:1 1 420px">
      <div class="muted" style="font-size:12px;margin:0 0 4px">Filter (Company)</div>
      <input id="filterInput" type="text" placeholder="Type to filter‚Ä¶" />
    </div>
    <button id="refreshBtn">Refresh Data</button>
    <button id="clearBtn">Clear Selection</button>
    <div class="load-status" id="loadStatus">
      <div class="load-bar"><div class="load-bar-fill" id="loadBarFill"></div></div>
      <div class="load-items" id="loadItems"></div>
    </div>
  </div>

  <div class="grid">
    <div class="chart-card">
      <h3>News sentiment (percent of articles)</h3>
      <div class="chart-actions">
        <span class="dates-range muted" aria-live="polite"></span>
        <div class="dates-pager">
          <button class="dates-prev" title="Older window">‚Üê</button>
          <button class="dates-next" title="Newer window">‚Üí</button>
        </div>
      </div>
      <canvas id="newsChart"></canvas>
    </div>

    <div class="chart-card">
      <h3>SERP (Negative % ‚Ä¢ Control %)</h3>
      <div class="chart-actions">
        <span class="dates-range muted" aria-live="polite"></span>
        <div class="dates-pager">
          <button class="dates-prev" title="Older window">‚Üê</button>
          <button class="dates-next" title="Newer window">‚Üí</button>
        </div>
      </div>
      <canvas id="serpChart"></canvas>
    </div>
  </div>

  <div class="table-card">
    <p class="table-hint">Select a company using the checkbox to view its trend lines. Click the sparkline to see 30-day stock chart with negative article markers.</p>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>Company</th>
            <th data-key="stock_price">
              <div class="tooltip-header">
                Stock Price
                <span class="tooltip-text">Current stock price from today's market open (or latest available)</span>
              </div>
            </th>
            <th data-key="daily_change">
              <div class="tooltip-header">
                Overnight<br>Change % ‚ñ≤‚ñº
                <span class="tooltip-text">Percentage change from yesterday's close to today's market open (overnight gap)</span>
              </div>
            </th>
            <th data-key="trend">
              <div class="tooltip-header">
                30-Day Trend
                <span class="tooltip-text">Visual sparkline of stock price over 30 days. Click to view detailed chart with negative news articles overlaid as markers</span>
              </div>
            </th>
            <th data-key="neg_news">
              <div class="tooltip-header">
                Negative<br>News % ‚ñ≤‚ñº
                <span class="tooltip-text">Percentage of articles mentioning this company that have negative sentiment. Higher = greater negative coverage</span>
              </div>
            </th>
            <th data-key="neg_serp">
              <div class="tooltip-header">
                Negative<br>SERP % ‚ñ≤‚ñº
                <span class="tooltip-text">Percentage of results on Google's first page with negative sentiment about this company. Indicates public perception visibility</span>
              </div>
            </th>
            <th data-key="ctrl_pct">
              <div class="tooltip-header">
                SERP<br>Control % ‚ñ≤‚ñº
                <span class="tooltip-text">Percentage of Page 1 Google results owned/controlled by the company (official site, press releases, social). Higher = better reputation management</span>
              </div>
            </th>
            <th data-key="risk">
              <div class="tooltip-header">
                Risk<br>‚ñ≤‚ñº
                <span class="tooltip-text">Composite risk score based on Negative SERP % and Control %. High risk = significant negative search visibility with limited control. Low risk = minimal negative presence or strong narrative control.</span>
              </div>
            </th>
            <th>Headlines</th>
            <th>SERP</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="pagination">
      <button id="prevBtn">Prev</button>
      <div>Page <span id="pageNo">1</span> / <span id="pageTotal">1</span></div>
      <button id="nextBtn">Next</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="box">
    <header>
      <h3 id="modalTitle">Title</h3>
      <button id="modalClose">Close</button>
    </header>
    <div class="content" id="modalContent"></div>
  </div>
</div>

<!-- Stock Chart Modal with Heatmap Legend -->
<div id="stockChartModal" class="modal" role="dialog" aria-modal="true">
  <div class="box">
    <header>
      <h3 id="stockChartTitle">Stock Price History</h3>
      <button id="volumeToggle" class="volume-toggle">üìä Volume</button>
      <button id="trendsToggle" class="trends-toggle">üîç Trends</button>
      <span class="close" onclick="closeStockChart()">&times;</span>
    </header>
    <div class="content">
      <canvas id="stockChart"></canvas>
      <div id="heatmapLegend" class="heatmap-legend" style="display: none;">
        <div class="heatmap-legend-item">
          <div class="heatmap-legend-dot medium"></div>
          <span>3-5 Negative Articles</span>
        </div>
        <div class="heatmap-legend-item">
          <div class="heatmap-legend-dot high"></div>
          <span>6+ Negative Articles</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/********************** Config (brand) **********************/
const COUNTS_CANDIDATES   = ['/api/v1/daily_counts?kind=brand_articles'];
const SERPS_DAILY_CSV     = '/api/v1/daily_counts?kind=brand_serps';
const ARTICLES_DAILY_PATH = d => `/api/v1/processed_articles?date=${d}&entity=brand&kind=table`;
const HEADLINES_PATH      = d => `/api/v1/processed_articles?date=${d}&entity=brand&kind=modal`;
const SERP_PROCESSED_PATH = d => `/api/v1/processed_serps?date=${d}&entity=brand&kind=table`;
const SERP_ROWS_PATH      = d => `/api/v1/processed_serps?date=${d}&entity=brand&kind=modal`;

/********************** Runtime **********************/
let allCountsRows = [];
let serpsDaily    = [];
let filteredRows  = [];
let selectedCompany = null;
let currentSort = { key:null, dir:1 };
let currentPage = 1;
const PAGE_SIZE = 25;

let newsChart, serpChart, stockChart;
let globalStockData = {};
let showVolume = false; // Toggle state for volume display
let showTrends = false; // Toggle state for trends display
let globalTrendsData = {}; // Trends data by company

const _articlesCache = new Map();
const _serpAggCache  = new Map();
const _modalHeadlinesCache = new Map();
const _modalSerpCache = new Map();
const _loadSections = ['news','serps','stock','trends','negative'];
const _loadLabels = {
  news: 'News sentiment',
  serps: 'SERP metrics',
  stock: 'Stock data',
  trends: 'Trends data',
  negative: 'Negative summary'
};
let _loadState = {};

function initLoadStatus(){
  _loadState = Object.fromEntries(_loadSections.map(k => [k, 'loading']));
  const items = document.getElementById('loadItems');
  const wrap = document.getElementById('loadStatus');
  if (wrap) wrap.style.display = 'block';
  if (items){
    items.innerHTML = _loadSections.map(k => `<span class="load-pill" data-key="${k}">${_loadLabels[k] || k}: loading</span>`).join('');
  }
  updateLoadBar();
}

function setLoadStatus(key, state){
  _loadState[key] = state;
  const pill = document.querySelector(`.load-pill[data-key="${key}"]`);
  if (pill){
    pill.textContent = `${_loadLabels[key] || key}: ${state}`;
    pill.classList.toggle('done', state === 'done');
    pill.classList.toggle('error', state === 'error');
  }
  updateLoadBar();
}

function updateLoadBar(){
  const total = _loadSections.length;
  const done = Object.values(_loadState).filter(v => v === 'done').length;
  const fill = document.getElementById('loadBarFill');
  if (fill){
    fill.style.width = `${Math.round((done / total) * 100)}%`;
  }
  const wrap = document.getElementById('loadStatus');
  if (wrap && done === total){
    wrap.style.display = 'none';
  }
}

const DATE_WINDOW_SIZE = 30;
let dateWindowStart = null;

/********************** Utils **********************/
const isISODate = s => /^\d{4}-\d{2}-\d{2}$/.test(String(s||'').trim());
const esc = (s) => String(s ?? '').replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
const fmtPct = (v) => (v==null) ? 'N/A' : Math.round(v*100)+'%';

const NEG_COLOR   = '#ff8261';
const CTRL_COLOR  = '#58dbed';
const SOLID_WIDTH = 3;
const DASH_WIDTH  = 2;
const DASH_PATTERN = [8, 6];

/********************** Stock Data **********************/
async function loadStockData() {
  try {
    const now = new Date();
    const todayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
    
    console.log('üìä Looking for most recent stock data...');
    
    // Try up to 7 days back to find the most recent stock data file
    // This handles weekends and holidays
    for (let daysBack = 0; daysBack < 7; daysBack++) {
      const checkDate = new Date(todayUTC);
      checkDate.setUTCDate(checkDate.getUTCDate() - daysBack);
      const dateStr = checkDate.toISOString().split('T')[0];
      
      try {
        const url = getDataUrl(`data/stock_prices/${dateStr}-stock-data.csv`);
        console.log(`üîç Trying: ${url}`);
        
        const response = await fetch(url, {cache:'no-store'});
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const text = await response.text();
        const stockData = parseStockCSV(text);
        
        console.log(`‚úÖ Successfully loaded stock data from ${dateStr} (${daysBack} day(s) old)`);
        console.log(`üìà Found data for ${Object.keys(stockData).length} companies`);
        
        return stockData;
      } catch (error) {
        console.log(`‚ö†Ô∏è  ${dateStr}: ${error.message}`);
        // Continue to next day
      }
    }
    
    // If we get here, no stock data was found in the last 7 days
    console.error('‚ùå No stock data found in the last 7 days');
    setLoadStatus('stock', 'error');
    return {};
    
  } catch (error) {
    console.error('‚ùå STOCK DATA LOAD FAILED:', error);
    setLoadStatus('stock', 'error');
    return {};
  }
}

function parseStockCSV(csvText) {
  const lines = csvText.trim().split('\n');
  const stockData = {};

  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;

    const values = line.split(',');
    if (values.length < 8) continue;

    const company = values[1];
    stockData[company] = {
      ticker: values[0],
      company: values[1],
      openingPrice: parseFloat(values[2]) || null,
      dailyChange: parseFloat(values[3]) || null,
      sevenDayChange: parseFloat(values[4]) || null,
      priceHistory: values[5] ? values[5].split('|').map(p => parseFloat(p)).filter(p => !isNaN(p)) : [],
      dateHistory: values[6] ? values[6].split('|') : [],
      volumeHistory: values[7] ? values[7].split('|').map(v => parseFloat(v)).filter(v => !isNaN(v)) : [],
      lastUpdated: values[8]
    };
  }

  return stockData;
}

function createSparkline(prices, isPositive) {
  if (!prices || prices.length < 2) return null;

  const canvas = document.createElement('canvas');
  canvas.width = 80;
  canvas.height = 24;
  canvas.className = 'sparkline';

  const ctx = canvas.getContext('2d');
  const width = canvas.width;
  const height = canvas.height;
  const padding = 2;

  const min = Math.min(...prices);
  const max = Math.max(...prices);
  const range = max - min || 1;

  const stepX = (width - padding * 2) / (prices.length - 1);

  ctx.beginPath();
  ctx.strokeStyle = isPositive ? '#82c616' : '#ff8261';
  ctx.lineWidth = 1.5;

  prices.forEach((price, i) => {
    const x = padding + i * stepX;
    const y = height - padding - ((price - min) / range) * (height - padding * 2);

    if (i === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }
  });

  ctx.stroke();

  return canvas;
}

/********************** NEGATIVE ARTICLES HEATMAP INTEGRATION **********************/

// Global variable to store the negative articles summary
let negativeSummaryMap = null;

// Threshold: minimum number of negative articles required to show a marker
const NEGATIVE_ARTICLE_THRESHOLD = 3;

async function loadNegativeSummary() {
  const logLabel = 'negative-summary';
  console.time(logLabel);
  console.log('üì∞ Loading negative articles summary...');
  
  try {
    const rows = await fetchCsv('/api/v1/negative_summary');
    console.log(`üìä Negative summary rows: ${rows.length}`);
    
    console.log(`üìä Loaded ${rows.length} total rows from summary file`);
    
    const summaryMap = new Map();
    
    rows.forEach(r => {
      const company = String(r.company || '').trim();
      if (!company || company === 'nan') return;
      
      const count = parseInt(r.negative_count) || 0;
      if (count < NEGATIVE_ARTICLE_THRESHOLD) return;
      
      if (!summaryMap.has(company)) {
        summaryMap.set(company, []);
      }
      
      const type = String(r.article_type || '').trim();
      
      summaryMap.get(company).push({
        date: String(r.date || '').trim(),
        count: count,
        headlines: (r.top_headlines || '').split('|').filter(h => h.trim()),
        type: type
      });
    });
    
    console.log(`‚úÖ Loaded negative summary for ${summaryMap.size} companies`);
    console.timeEnd(logLabel);
    setLoadStatus('negative', 'done');
    return summaryMap;
    
  } catch (e) {
    console.error('‚ùå Failed to load negative summary:', e);
    console.timeEnd(logLabel);
    setLoadStatus('negative', 'error');
    return new Map();
  }
}

/**
 * Enhanced stock chart with negative article heatmap markers, responsive design, improved legend
 */

// Load Google Trends data
async function loadTrendsData() {
  try {
    const now = new Date();
    const todayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
    
    console.log('üîç Looking for most recent trends data...');
    
    for (let daysBack = 0; daysBack < 7; daysBack++) {
      const checkDate = new Date(todayUTC);
      checkDate.setUTCDate(checkDate.getUTCDate() - daysBack);
      const dateStr = checkDate.toISOString().split('T')[0];
      
      try {
        const url = getDataUrl(`data/trends_data/${dateStr}-trends-data.csv`);
        console.log(`üîç Trying: ${url}`);
        
        const response = await fetch(url, {cache:'no-store'});
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const text = await response.text();
        const trendsData = parseTrendsCSV(text);
        
        console.log(`‚úÖ Successfully loaded trends data from ${dateStr} (${daysBack} day(s) old)`);
        console.log(`üìà Found trends for ${Object.keys(trendsData).length} companies`);
        setLoadStatus('trends', 'done');
        return trendsData;
      } catch (error) {
        console.log(`‚ö†Ô∏è  ${dateStr}: ${error.message}`);
      }
    }
    
    console.warn('‚ö†Ô∏è  No trends data found in the last 7 days');
    setLoadStatus('trends', 'error');
    return {};
    
  } catch (error) {
    console.error('‚ùå TRENDS DATA LOAD FAILED:', error);
    setLoadStatus('trends', 'error');
    return {};
  }
}

function parseTrendsCSV(csvText) {
  const lines = csvText.trim().split('\n');
  const trendsData = {};

  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;

    const values = line.split(',');
    if (values.length < 3) continue;

    const company = values[0];
    trendsData[company] = {
      company: values[0],
      trendsHistory: values[1] ? values[1].split('|').map(v => parseFloat(v)).filter(v => !isNaN(v)) : [],
      dateHistory: values[2] ? values[2].split('|') : [],
      lastUpdated: values[3] || ''
    };
  }

  return trendsData;
}

async function showStockChart(company) {
  const stock = globalStockData[company];
  if (!stock || !stock.priceHistory || !stock.priceHistory.length) {
    alert('No stock data available for this company');
    return;
  }
  
  const modal = document.getElementById('stockChartModal');
  document.getElementById('stockChartTitle').textContent = 
    `${company} (${stock.ticker}) - 30-Day Price History`;
  modal.classList.add('open');
  
  if (stockChart) stockChart.destroy();
  
  const negativeDates = negativeSummaryMap?.get(company) || [];
  const relevantNegatives = negativeDates.filter(item => 
    stock.dateHistory.includes(item.date)
  );
  
  const negativesByDate = new Map();
  relevantNegatives.forEach(item => {
    if (!negativesByDate.has(item.date)) {
      negativesByDate.set(item.date, {
        totalCount: 0,
        ceoCount: 0,
        brandCount: 0,
        allHeadlines: []
      });
    }
    const agg = negativesByDate.get(item.date);
    agg.totalCount += item.count;
    if (item.type === 'ceo') agg.ceoCount += item.count;
    if (item.type === 'brand') agg.brandCount += item.count;
    agg.allHeadlines.push(...item.headlines);
  });
  
  console.log(`üìä ${company}: ${negativesByDate.size} dates with ${NEGATIVE_ARTICLE_THRESHOLD}+ negative articles`);
  
  const legendEl = document.getElementById('heatmapLegend');
  if (negativesByDate.size > 0) {
    legendEl.style.display = 'flex';
  } else {
    legendEl.style.display = 'none';
  }
  
  const annotations = {};
  Array.from(negativesByDate.entries()).forEach(([date, data], idx) => {
    const priceIndex = stock.dateHistory.indexOf(date);
    if (priceIndex === -1) return;
    
    const price = stock.priceHistory[priceIndex];
    const intensity = data.totalCount >= 6 ? 'high' : 'medium';
    
    annotations[`negArticle${idx}`] = {
      type: 'point',
      xValue: date,
      yValue: price,
      yScaleID: 'yPrice',
      backgroundColor: intensity === 'high' ? '#ff4444' : '#ffaa44',
      borderColor: '#ffffff',
      borderWidth: 2,
      radius: Math.min(data.totalCount + 3, 14),
      enter(context) {
        context.element.options.radius = Math.min(data.totalCount + 5, 18);
        context.element.options.borderWidth = 3;
        stockChart.update('none');
        return true;
      },
      leave(context) {
        context.element.options.radius = Math.min(data.totalCount + 3, 14);
        context.element.options.borderWidth = 2;
        stockChart.update('none');
        return true;
      }
    };
  });
  
  const ctx = document.getElementById('stockChart').getContext('2d');
  // Match sparkline logic: compare first to last price in 30-day window
  const firstPrice = stock.priceHistory[0];
  const lastPrice = stock.priceHistory[stock.priceHistory.length - 1];
  const isPositive = lastPrice >= firstPrice;  
  
  const datasets = [{
    label: 'Closing Price ($)',
    data: stock.priceHistory,
    borderColor: isPositive ? '#82c616' : '#ff8261',
    backgroundColor: isPositive ? 'rgba(130, 198, 22, 0.1)' : 'rgba(255, 130, 97, 0.1)',
    borderWidth: 2,
    tension: 0.1,
    fill: true,
    pointRadius: 2,
    pointHoverRadius: 5,
    yAxisID: 'yPrice',
    type: 'line',
    order: 1
  }];
  
  if (showVolume && stock.volumeHistory && stock.volumeHistory.length > 0) {
    datasets.push({
      label: 'Volume',
      data: stock.volumeHistory,
      backgroundColor: 'rgba(88, 219, 237, 0.3)',
      borderColor: 'rgba(88, 219, 237, 0.5)',
      borderWidth: 1,
      yAxisID: 'yVolume',
      type: 'bar',
      order: 2,
      barPercentage: 0.9,
      categoryPercentage: 0.95
    });
  }
  
  const trendsData = globalTrendsData[company];
  if (showTrends && trendsData && trendsData.trendsHistory && trendsData.trendsHistory.length > 0) {
    datasets.push({
      label: 'Search Interest',
      data: trendsData.trendsHistory,
      borderColor: '#a855f7',
      backgroundColor: 'rgba(168, 85, 247, 0.1)',
      borderWidth: 2,
      tension: 0.3,
      fill: false,
      yAxisID: 'yTrends',
      type: 'line',
      order: 0,
      pointRadius: 3,
      pointHoverRadius: 5,
      pointBackgroundColor: '#a855f7',
      pointBorderColor: '#ffffff',
      pointBorderWidth: 1
    });
  }
  
  stockChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: stock.dateHistory,
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: { 
          display: false,
          position: 'top',
          labels: {
            color: '#ffffff',
            font: {
              size: window.innerWidth < 768 ? 11 : 13,
              weight: '500'
            },
            padding: 12,
            usePointStyle: true,
            pointStyle: 'circle',
            boxWidth: 8,
            boxHeight: 8,
            generateLabels: function(chart) {
              const labels = [
                {
                  text: 'Stock Price',
                  fillStyle: isPositive ? '#82c616' : '#ff8261',
                  strokeStyle: isPositive ? '#82c616' : '#ff8261',
                  lineWidth: 2,
                  pointStyle: 'line'
                }
              ];
              
              if (showVolume && stock.volumeHistory && stock.volumeHistory.length > 0) {
                labels.push({
                  text: 'Trading Volume',
                  fillStyle: 'rgba(88, 219, 237, 0.3)',
                  strokeStyle: 'rgba(88, 219, 237, 0.5)',
                  lineWidth: 1,
                  pointStyle: 'rect'
                });
              }
              
              if (showTrends && trendsData && trendsData.trendsHistory && trendsData.trendsHistory.length > 0) {
                labels.push({
                  text: 'Search Interest (0-100)',
                  fillStyle: 'rgba(168, 85, 247, 0.1)',
                  strokeStyle: '#a855f7',
                  lineWidth: 2,
                  pointStyle: 'line'
                });
              }
              
              if (negativesByDate.size > 0) {
                let totalCeo = 0, totalBrand = 0;
                negativesByDate.forEach(data => {
                  totalCeo += data.ceoCount;
                  totalBrand += data.brandCount;
                });
                
                if (totalCeo > 0 && totalBrand > 0) {
                  labels.push({
                    text: `Negative Articles (${totalCeo} CEO, ${totalBrand} Brand)`,
                    fillStyle: '#ffaa44',
                    strokeStyle: '#ffffff',
                    lineWidth: 2,
                    pointStyle: 'circle'
                  });
                } else if (totalCeo > 0) {
                  labels.push({
                    text: `Negative CEO Articles (${totalCeo})`,
                    fillStyle: '#ffaa44',
                    strokeStyle: '#ffffff',
                    lineWidth: 2,
                    pointStyle: 'circle'
                  });
                } else if (totalBrand > 0) {
                  labels.push({
                    text: `Negative Brand Articles (${totalBrand})`,
                    fillStyle: '#ffaa44',
                    strokeStyle: '#ffffff',
                    lineWidth: 2,
                    pointStyle: 'circle'
                  });
                }
              }
              
              return labels;
            }
          }
        },
        annotation: {
          annotations: annotations
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: 'rgba(255, 255, 255, 0.3)',
          borderWidth: 1,
          padding: window.innerWidth < 768 ? 10 : 14,
          displayColors: false,
          titleFont: {
            size: window.innerWidth < 768 ? 12 : 13,
            weight: 'bold'
          },
          bodyFont: {
            size: window.innerWidth < 768 ? 11 : 12
          },
          callbacks: {
            title: function(tooltipItems) {
              if (!tooltipItems || tooltipItems.length === 0) return '';
              return tooltipItems[0].label;
            },
            label: function(context) {
              const lines = [];
              
              if (context.dataset.yAxisID === 'yVolume') {
                const vol = context.parsed.y;
                const volStr = vol >= 1000000 
                  ? `${(vol / 1000000).toFixed(2)}M` 
                  : vol >= 1000 
                    ? `${(vol / 1000).toFixed(2)}K` 
                    : vol.toFixed(0);
                return [`Volume: ${volStr}`];
              }
              
              if (context.dataset.yAxisID === 'yTrends') {
                return [`Search Interest: ${context.parsed.y.toFixed(0)}/100`];
              }
              
              lines.push(`Price: $${context.parsed.y.toFixed(2)}`);
              
              const date = context.label;
              const negData = negativesByDate.get(date);
              
              if (negData) {
                lines.push('');
                lines.push(`‚ö†Ô∏è  ${negData.totalCount} Negative Article${negData.totalCount > 1 ? 's' : ''}`);
                
                if (negData.ceoCount > 0) {
                  lines.push(`   CEO: ${negData.ceoCount}`);
                }
                if (negData.brandCount > 0) {
                  lines.push(`   Brand: ${negData.brandCount}`);
                }
                
                const previewHeadlines = negData.allHeadlines.slice(0, 3);
                if (previewHeadlines.length > 0) {
                  lines.push('');
                  previewHeadlines.forEach((headline, i) => {
                    const maxLength = window.innerWidth < 768 ? 40 : 55;
                    const truncated = headline.length > maxLength 
                      ? headline.substring(0, maxLength - 3) + '...' 
                      : headline;
                    lines.push(`‚Ä¢ ${truncated}`);
                  });
                  
                  if (negData.allHeadlines.length > 3) {
                    lines.push(`   ... and ${negData.allHeadlines.length - 3} more`);
                  }
                }
              }
              
              return lines;
            }
          }
        }
      },
      scales: {
        yPrice: {
          type: 'linear',
          position: 'left',
          beginAtZero: false,
          ticks: {
            color: '#ebf2f2',
            font: {
              size: window.innerWidth < 768 ? 10 : 11
            },
            callback: function(value) {
              return '$' + value.toFixed(2);
            }
          },
          grid: {
            color: 'rgba(255,255,255,.08)'
          }
        },
        yVolume: {
          type: 'linear',
          position: 'right',
          display: showVolume && stock.volumeHistory && stock.volumeHistory.length > 0,
          beginAtZero: true,
          ticks: {
            color: 'rgba(88, 219, 237, 0.8)',
            font: {
              size: window.innerWidth < 768 ? 9 : 10
            },
            callback: function(value) {
              if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
              if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
              return value.toFixed(0);
            }
          },
          grid: {
            display: false
          }
        },
        yTrends: {
          type: 'linear',
          position: 'right',
          display: showTrends && trendsData && trendsData.trendsHistory && trendsData.trendsHistory.length > 0,
          beginAtZero: true,
          max: 100,
          ticks: {
            color: 'rgba(168, 85, 247, 0.8)',
            font: {
              size: window.innerWidth < 768 ? 9 : 10
            },
            callback: function(value) {
              return value.toFixed(0);
            }
          },
          grid: {
            display: false
          },
          offset: showVolume
        },
        x: {
          ticks: {
            color: '#ebf2f2',
            font: {
              size: window.innerWidth < 768 ? 9 : 11
            },
            maxTicksLimit: window.innerWidth < 768 ? 6 : 10,
            autoSkip: true
          },
          grid: {
            color: 'rgba(255,255,255,.05)'
          }
        }
      }
    }
  });
  
  const volumeBtn = document.getElementById('volumeToggle');
  if (volumeBtn) {
    if (showVolume) {
      volumeBtn.classList.add('active');
    } else {
      volumeBtn.classList.remove('active');
    }
    
    if (!stock.volumeHistory || stock.volumeHistory.length === 0) {
      volumeBtn.style.display = 'none';
    } else {
      volumeBtn.style.display = 'block';
    }
    
    const newBtn = volumeBtn.cloneNode(true);
    volumeBtn.parentNode.replaceChild(newBtn, volumeBtn);
    
    newBtn.onclick = () => {
      showVolume = !showVolume;
      showStockChart(company);
    };
  }
  
  const trendsBtn = document.getElementById('trendsToggle');
  if (trendsBtn) {
    if (showTrends) {
      trendsBtn.classList.add('active');
    } else {
      trendsBtn.classList.remove('active');
    }
    
    const trendsData = globalTrendsData[company];
    if (!trendsData || !trendsData.trendsHistory || trendsData.trendsHistory.length === 0) {
      trendsBtn.style.display = 'none';
    } else {
      trendsBtn.style.display = 'block';
    }
    
    const newTrendsBtn = trendsBtn.cloneNode(true);
    trendsBtn.parentNode.replaceChild(newTrendsBtn, trendsBtn);
    
    newTrendsBtn.onclick = () => {
      showTrends = !showTrends;
      showStockChart(company);
    };
  }
}


/**
 * Close the stock chart modal
 */
function closeStockChart() {
  document.getElementById('stockChartModal').classList.remove('open');
}

/* ===== Pager helpers ===== */
function clampDateStart(total){
  if (total <= DATE_WINDOW_SIZE) return 0;
  const maxStart = total - DATE_WINDOW_SIZE;
  const start = (dateWindowStart ?? maxStart);
  return Math.min(Math.max(0, start), maxStart);
}
function sliceWindow(arr, start, size){ return arr.slice(start, start + size); }
function updateDateRangeUI(allDates){
  const start = clampDateStart(allDates.length);
  const end = Math.min(allDates.length, start + DATE_WINDOW_SIZE);
  const label = allDates.length ? `${allDates[start]} ‚Äî ${allDates[end - 1]}` : '';
  document.querySelectorAll('.dates-range').forEach(el => el.textContent = label);

  const atStart = start === 0;
  const atEnd   = (start + DATE_WINDOW_SIZE) >= allDates.length;
  document.querySelectorAll('.dates-prev').forEach(b => b.disabled = atStart);
  document.querySelectorAll('.dates-next').forEach(b => b.disabled = atEnd);
}
function hookDatePager(allDates){
  const goPrev = () => {
    const total = allDates.length;
    if (total <= DATE_WINDOW_SIZE) return;
    dateWindowStart = clampDateStart(total) - DATE_WINDOW_SIZE;
    if (dateWindowStart < 0) dateWindowStart = 0;
    renderCharts();
  };
  const goNext = () => {
    const total = allDates.length;
    if (total <= DATE_WINDOW_SIZE) return;
    const maxStart = total - DATE_WINDOW_SIZE;
    dateWindowStart = Math.min(maxStart, clampDateStart(total) + DATE_WINDOW_SIZE);
    renderCharts();
  };
  document.querySelectorAll('.dates-prev').forEach(b => b.onclick = goPrev);
  document.querySelectorAll('.dates-next').forEach(b => b.onclick = goNext);
}

/********************** CSV helpers **********************/
/********************** CSV Fetch with Preload Cache **********************/
const _preloadCache = new Map();

async function fetchCsv(url){
  // Check preload cache first
  if (_preloadCache.has(url)) {
    const cached = _preloadCache.get(url);
    if (cached instanceof Promise) {
      return await cached; // Wait for in-flight request
    }
    return cached; // Return cached data
  }
  
  // Fetch and cache
  const fetchPromise = (async () => {
    const r = await fetch(url, {cache:'default'}); // Changed from no-store to allow browser caching
    if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
    const contentType = r.headers.get('content-type') || '';
    if (contentType.includes('application/json') || url.includes('/api/v1/')) {
      return await r.json();
    }
    const t = await r.text();
    return await new Promise((res,rej)=>Papa.parse(t,{header:true,skipEmptyLines:true,complete:o=>res(o.data||[]),error:e=>rej(e)}));
  })();
  
  _preloadCache.set(url, fetchPromise);
  
  try {
    const data = await fetchPromise;
    _preloadCache.set(url, data); // Replace promise with actual data
    return data;
  } catch (e) {
    _preloadCache.delete(url); // Remove failed requests from cache
    throw e;
  }
}

async function fetchCsvAny(cands){
  for (const u of cands){ try{ const rows = await fetchCsv(u); if (Array.isArray(rows)) return rows; } catch{} }
  return [];
}

// Preload modal data in background for faster popup
function preloadModalData(date) {
  // Fire and forget - preload into our JS cache
  const headlinesUrl = HEADLINES_PATH(date);
  const serpUrl = SERP_ROWS_PATH(date);
  
  // Start fetches using fetchCsv (populates _preloadCache)
  fetchCsv(headlinesUrl).catch(() => {}); // Ignore errors
  fetchCsv(serpUrl).catch(() => {});
  
  console.log(`üì¶ Preloading modal data for ${date}`);
}

/********************** Loaders **********************/
async function loadCounts(){
  try{
    const rows = await fetchCsvAny(COUNTS_CANDIDATES);
    allCountsRows = rows.map(r=>({
      date: String(r.date||'').trim(),
      company: String(r.company||'').trim(),
      pos: +r.positive||0,
      neu: +r.neutral||0,
      neg: +r.negative||0
    })).filter(r=>isISODate(r.date) && r.company);
    setLoadStatus('news', 'done');
  } catch (e){
    allCountsRows = [];
    setLoadStatus('news', 'error');
  }
}
async function loadSerpDaily(){
  try{
    const rows = await fetchCsv(SERPS_DAILY_CSV);
    serpsDaily = rows.map(r=>({
      date:(r.date||'').trim(),
      company:(r.company||'').trim(),
      total:+r.total||0,
      neg_serp:+r.negative_serp||+r.neg_serp||0,
      ctrl:+r.controlled||+r.control||0
    })).filter(r=>isISODate(r.date) && r.company);
    setLoadStatus('serps', 'done');
  }catch(e){
    serpsDaily = [];
    setLoadStatus('serps', 'error');
  }
}

/********************** Risk **********************/
function computeRisk(negPct, ctrlPct){
  if (negPct == null || isNaN(negPct)) return 'N/A';
  if (negPct > 0) return 'High';
  if (ctrlPct == null || isNaN(ctrlPct)) return 'N/A';
  return ctrlPct < 0.40 ? 'Medium' : 'Low';
}

/********************** Per-date sources **********************/
function toPct01(x){
  if (x==null || x==='') return null;
  const n = +String(x).replace('%','').trim();
  if (!isFinite(n)) return null;
  return n>1 ? n/100 : n;
}

async function getArticlesForDate(d){
  if (_articlesCache.has(d)) return _articlesCache.get(d);
  const map = new Map();
  try{
    const rows = await fetchCsv(ARTICLES_DAILY_PATH(d));
    rows.forEach(r=>{
      const company = String(r.company||'').trim();
      if (!company) return;
      let neg = toPct01(r.neg_pct);
      if (neg==null){
        const negCount = +r.negative||0;
        const tot = (+r.total) || ((+r.positive||0)+(+r.neutral||0)+negCount) || 0;
        neg = tot ? (negCount/tot) : 0;
      }
      map.set(company, { neg_pct: neg });
    });
  }catch{}
  _articlesCache.set(d,map);
  return map;
}

async function getSerpAggForDate(d){
  if (_serpAggCache.has(d)) return _serpAggCache.get(d);
  const map = new Map();
  try{
    const rows = await fetchCsv(SERP_PROCESSED_PATH(d));
    rows.forEach(r=>{
      const company = String(r.company||'').trim();
      if (!company) return;
      map.set(company,{ total:+r.total||0, neg_serp:+r.negative_serp||0, controlled:+r.controlled||0 });
    });
  }catch{}
  _serpAggCache.set(d,map);
  return map;
}

/********************** UI bootstrap ***********************/
async function init(){
  initLoadStatus();
  await Promise.all([
    loadCounts(), 
    loadSerpDaily(), 
    loadStockData().then(data => {
      globalStockData = data;
      if (Object.keys(globalStockData).length > 0) {
        setLoadStatus('stock', 'done');
      }
      return data;
    }),
    loadNegativeSummary().then(data => negativeSummaryMap = data),
    loadTrendsData().then(data => globalTrendsData = data)
  ]);

  console.log('üìà Stock data loaded. Companies with stock data:', Object.keys(globalStockData).length);
  if (Object.keys(globalStockData).length === 0) {
    console.warn('‚ö†Ô∏è  No stock data was loaded. Stock prices and sparklines will show N/A.');
  }

  const dateSet = new Set([ ...allCountsRows.map(r=>r.date), ...serpsDaily.map(r=>r.date) ].filter(isISODate));
  const dates = [...dateSet].sort();
  const sel = document.getElementById('dateSelect');
  sel.innerHTML = dates.map(d=>`<option value="${d}">${d}</option>`).join('');
  sel.value = dates[dates.length-1] || '';
  
  // 1. Date Change Listener (Keep this simple)
  sel.addEventListener('change', ()=>{ 
    currentPage=1; 
    selectedCompany=null; 
    renderAll(); 
    setTimeout(()=>{ if (sel.value) preloadModalData(sel.value); }, 150);
  });

  document.getElementById('filterInput').addEventListener('input', ()=>{ currentPage=1; renderAll(); });
  document.getElementById('refreshBtn').onclick = async ()=>{ await init(); };
  document.getElementById('clearBtn').onclick = ()=>{ selectedCompany=null; document.getElementById('filterInput').value=''; renderAll(); };
  document.getElementById('prevBtn').onclick = ()=>{ if (currentPage>1){ currentPage--; renderTable(); } };
  document.getElementById('nextBtn').onclick = ()=>{ const totalPages = Math.max(1, Math.ceil(filteredRows.length/PAGE_SIZE)); if (currentPage<totalPages){ currentPage++; renderTable(); } };

  // 2. Sorting Listeners (Define these ONCE, outside the change handler)
  document.querySelectorAll('thead th[data-key]').forEach(th=>{
    th.style.cursor='pointer';
    th.addEventListener('click', ()=>{
      const k = th.getAttribute('data-key');
      if (currentSort.key===k) currentSort.dir*=-1; else { currentSort.key=k; currentSort.dir=1; }
      renderTable();
    });
  });

  // --- [NEW] AUTO-FILTER FROM URL (Correct Location) ---
  // This runs once when the page loads
  const urlParams = new URLSearchParams(window.location.search);
  const companyParam = urlParams.get('company');
  if (companyParam) {
    const input = document.getElementById('filterInput');
    if (input) {
      input.value = companyParam;
    }
  }
  // ----------------------------------

  renderAll();
  if (sel.value) {
    setTimeout(()=>{ preloadModalData(sel.value); }, 150);
  }

  const ro = new ResizeObserver(()=>{ if (newsChart) newsChart.resize(); if (serpChart) serpChart.resize(); });
  ro.observe(document.getElementById('newsChart').parentElement);
  ro.observe(document.getElementById('serpChart').parentElement);

  window.onclick = function(event) {
    if (event.target === document.getElementById('stockChartModal')) {
      closeStockChart();
    }
  };
}

/********************** Data ‚Üí view rows **********************/
async function buildRowsForDate(d){
  const articles = await getArticlesForDate(d);
  const serpAgg  = await getSerpAggForDate(d);

  const out = [];
  for (const [company, a] of articles.entries()){
    const s = serpAgg.get(company);
    let negSerpPct=null, ctrlPct=null;
    if (s && s.total>0){ negSerpPct = s.neg_serp/s.total; ctrlPct = s.controlled/s.total; }
    const risk = computeRisk(negSerpPct, ctrlPct);
    
    const stock = globalStockData[company];
    const dailyChange = stock?.dailyChange ?? null;
    
    out.push({
      date:d,
      company,
      neg_news:a.neg_pct ?? 0,
      neg_serp:negSerpPct,
      ctrl_pct:ctrlPct,
      daily_change: dailyChange,
      risk
    });
  }
  return out;
}

/********************** Rendering **********************/
async function renderAll(){
  const d = document.getElementById('dateSelect').value;
  const filter = document.getElementById('filterInput').value.trim().toLowerCase();
  const rows = (await buildRowsForDate(d)).filter(r => !filter || r.company.toLowerCase().includes(filter));
  filteredRows = rows;
  currentPage = 1;
  if (rows.length === 1) {
    selectedCompany = rows[0].company;
  } else if (selectedCompany && !rows.some(r => r.company === selectedCompany)) {
    selectedCompany = null;
  }
  renderTable();
  renderCharts();
}

function renderTable(){
  const tbody = document.getElementById('tbody');
  let rows = [...filteredRows];

  if (currentSort.key){
    rows.sort((a,b)=>{
      const ka=a[currentSort.key], kb=b[currentSort.key];
      if (typeof ka==='string') return currentSort.dir*ka.localeCompare(kb);
      return currentSort.dir*((ka??-1)-(kb??-1));
    });
  }

  const start = (currentPage-1)*PAGE_SIZE;
  const pageRows = rows.slice(start, start+PAGE_SIZE);

  const rowsHTML = pageRows.map(r=>{
    const checked = (selectedCompany && selectedCompany===r.company) ? 'checked' : '';
    const stock = globalStockData[r.company];
    let stockPriceHtml = '<span class="muted">N/A</span>';
    let dailyChangeHtml = '<span class="muted">N/A</span>';
    let sparklineId = '';

    if (stock && stock.openingPrice !== null) {
      stockPriceHtml = `<span class="stock-price">$${stock.openingPrice.toFixed(2)}</span>`;

      if (stock.dailyChange !== null) {
        const changeClass = stock.dailyChange >= 0 ? 'positive' : 'negative';
        const changeSymbol = stock.dailyChange >= 0 ? '‚ñ≤' : '‚ñº';
        dailyChangeHtml = `<span class="stock-change ${changeClass}">${changeSymbol} ${Math.abs(stock.dailyChange).toFixed(2)}%</span>`;
      }

      sparklineId = `sparkline-${r.company.replace(/[^a-zA-Z0-9]/g, '-')}`;
    }

    return `<tr data-company="${esc(r.company)}">
      <td>
        <div class="brand-cell-content">
          <input type="checkbox" data-company="${esc(r.company)}" class="brandCheck" ${checked} onclick="event.stopPropagation()" />
          <div class="brand-name">${esc(r.company)}</div>
        </div>
      </td>
      <td>${stockPriceHtml}</td>
      <td>${dailyChangeHtml}</td>
      <td class="sparkline-cell"><span id="${sparklineId}"></span></td>
      <td>${fmtPct(r.neg_news)}</td>
      <td>${fmtPct(r.neg_serp)}</td>
      <td>${fmtPct(r.ctrl_pct)}</td>
      <td>${
        (r.risk==='High'||r.risk==='Medium'||r.risk==='Low')
          ? (r.risk==='High'
              ? '<span class="pill high">High</span>'
              : r.risk==='Medium'
                ? '<span class="pill med">Medium</span>'
                : '<span class="pill low">Low</span>')
          : '<span class="muted">N/A</span>'
      }</td>
      <td><button class="headBtn" data-company="${esc(r.company)}" onclick="event.stopPropagation()">View</button></td>
      <td><button class="serpBtn" data-company="${esc(r.company)}" onclick="event.stopPropagation()">View</button></td>
    </tr>`;
  }).join('');

  tbody.innerHTML = rowsHTML;

  pageRows.forEach(r => {
    const stock = globalStockData[r.company];
    if (stock && stock.priceHistory && stock.priceHistory.length >= 2) {
      const sparklineId = `sparkline-${r.company.replace(/[^a-zA-Z0-9]/g, '-')}`;
      const container = document.getElementById(sparklineId);
      if (container) {
        const firstPrice = stock.priceHistory[0];
        const lastPrice = stock.priceHistory[stock.priceHistory.length - 1];
        const isPositive = lastPrice >= firstPrice;
        container.innerHTML = '';
        const canvas = createSparkline(stock.priceHistory, isPositive);
        if (canvas) container.appendChild(canvas);

        const sparklineCell = container.closest('td');
        if (sparklineCell) {
          sparklineCell.onclick = (e) => {
            e.stopPropagation();
            showStockChart(r.company);
          };
        }
      }
    }
  });

  tbody.querySelectorAll('.brandCheck').forEach(cb=>{
    cb.addEventListener('change',(e)=>{
      const company = e.target.getAttribute('data-company');
      if (e.target.checked){
        selectedCompany = company;
        tbody.querySelectorAll('.brandCheck').forEach(x=>{ if (x!==e.target) x.checked=false; });
      } else selectedCompany=null;
      renderCharts();
    });
  });
  tbody.querySelectorAll('.serpBtn').forEach(btn=>{
    btn.onclick = ()=> showSerp({ company: btn.getAttribute('data-company') });
  });
  tbody.querySelectorAll('.headBtn').forEach(btn=>{
    btn.onclick = ()=> showHeadlines({ company: btn.getAttribute('data-company') });
  });

  document.getElementById('pageNo').textContent = String(currentPage);
  document.getElementById('pageTotal').textContent = String(Math.max(1, Math.ceil(filteredRows.length/PAGE_SIZE)));
}

/********************** Charts **********************/
function getDateSeries(){
  const byDate = new Map();
  allCountsRows.forEach(r=>{
    const key=r.date;
    if (!byDate.has(key)) byDate.set(key,{pos:0,neu:0,neg:0});
    const b=byDate.get(key);
    if (!selectedCompany || r.company===selectedCompany){
      b.pos += +r.pos||0; b.neu += +r.neu||0; b.neg += +r.neg||0;
    }
  });

  const serpByDate = new Map();
  serpsDaily.forEach(r=>{
    const key=r.date;
    if (!serpByDate.has(key)) serpByDate.set(key,{total:0,neg:0,ctrl:0});
    if (!selectedCompany || r.company===selectedCompany){
      const b=serpByDate.get(key);
      b.total += +r.total||0; b.neg += +r.neg_serp||0; b.ctrl += +r.ctrl||0;
    }
  });

  const dates=[...new Set([...byDate.keys(),...serpByDate.keys()])].filter(isISODate).sort();
  const newsPos=[],newsNeu=[],newsNeg=[],serpNegPct=[],serpCtrlPct=[];
  dates.forEach(d=>{
    const n=byDate.get(d)||{pos:0,neu:0,neg:0};
    const t=n.pos+n.neu+n.neg||0;
    newsPos.push(t? n.pos/t*100 : 0);
    newsNeu.push(t? n.neu/t*100 : 0);
    newsNeg.push(t? n.neg/t*100 : 0);

    const s=serpByDate.get(d)||{total:0,neg:0,ctrl:0};
    serpNegPct.push(s.total? s.neg/s.total*100 : 0);
    serpCtrlPct.push(s.total? s.ctrl/s.total*100 : 0);
  });
  return {dates,newsPos,newsNeu,newsNeg,serpNegPct,serpCtrlPct};
}

function renderCharts(){
  const {dates, newsPos, newsNeu, newsNeg, serpNegPct, serpCtrlPct} = getDateSeries();

  if (dateWindowStart === null){
    dateWindowStart = Math.max(0, dates.length - DATE_WINDOW_SIZE);
  }
  const start = clampDateStart(dates.length);
  const d  = sliceWindow(dates,       start, DATE_WINDOW_SIZE);
  const nP = sliceWindow(newsPos,     start, DATE_WINDOW_SIZE);
  const nN = sliceWindow(newsNeu,     start, DATE_WINDOW_SIZE);
  const nG = sliceWindow(newsNeg,     start, DATE_WINDOW_SIZE);
  const sN = sliceWindow(serpNegPct,  start, DATE_WINDOW_SIZE);
  const sC = sliceWindow(serpCtrlPct, start, DATE_WINDOW_SIZE);

  updateDateRangeUI(dates);
  hookDatePager(dates);

  const who = selectedCompany ? selectedCompany : 'Index Average';
  const pct = v => `${Math.round(v)}%`;

  const commonOpts = {
    responsive:true, maintainAspectRatio:false,
    layout:{ padding:{ bottom:24 } },
    scales:{
      x:{ ticks:{color:'#ebf2f2'}, grid:{color:'rgba(255,255,255,.05)'} },
      y:{ ticks:{color:'#ebf2f2', stepSize:20, callback:v=>pct(v)},
          grid:{color:'rgba(255,255,255,.06)'}, suggestedMin:0, suggestedMax:100 }
    },
    plugins:{
      legend:{labels:{color:'#ebf2f2'}},
      title:{display:true, text:who, color:'#ebf2f2', font:{weight:'bold', size:14},
             padding:{top:10,bottom:6}},
      tooltip:{callbacks:{label:(ctx)=>`${ctx.dataset?.label?ctx.dataset.label+': ':''}${pct(typeof ctx.parsed.y==='number'?ctx.parsed.y:ctx.parsed)}`}}
    }
  };

  const nh = document.getElementById('newsChart').getContext('2d');
  if (newsChart) newsChart.destroy();
  newsChart = new Chart(nh, {
    type:'bar',
    data:{ labels:d, datasets:[
      {label:'Positive %',data:nP, backgroundColor:'#82c618', stack:'s'},
      {label:'Neutral %', data:nN, backgroundColor:'#cfdbdd', stack:'s'},
      {label:'Negative %',data:nG, backgroundColor:'#ff8261', stack:'s'}
    ]},
    options:{...commonOpts}
  });

  const avgNegAll  = 1;
  const avgCtrlAll = 46;
  const avgNegLine  = new Array(d.length).fill(avgNegAll);
  const avgCtrlLine = new Array(d.length).fill(avgCtrlAll);

  const sh = document.getElementById('serpChart').getContext('2d');
  if (serpChart) serpChart.destroy();
  serpChart = new Chart(sh, {
    type: 'line',
    data: {
      labels: d,
      datasets: [
        {
          label: 'Daily Negative SERP %',
          data: sN,
          tension: 0.2,
          borderWidth: SOLID_WIDTH,
          fill: false,
          borderColor: NEG_COLOR,
          pointBackgroundColor: NEG_COLOR,
          pointBorderColor: NEG_COLOR
        },
        {
          label: 'Daily Control %',
          data: sC,
          tension: 0.2,
          borderWidth: SOLID_WIDTH,
          fill: false,
          borderColor: CTRL_COLOR,
          pointBackgroundColor: CTRL_COLOR,
          pointBorderColor: CTRL_COLOR
        },
        ...(avgNegLine.length ? [{
          label: 'Average Negative SERP %',
          data: avgNegLine,
          tension: 0,
          fill: false,
          borderWidth: DASH_WIDTH,
          borderDash: DASH_PATTERN,
          borderColor: NEG_COLOR,
          pointRadius: 0
        }] : []),
        ...(avgCtrlLine.length ? [{
          label: 'Average Daily Control %',
          data: avgCtrlLine,
          tension: 0,
          fill: false,
          borderWidth: DASH_WIDTH,
          borderDash: DASH_PATTERN,
          borderColor: CTRL_COLOR,
          pointRadius: 0
        }] : [])
      ]
    },
    options: { ...commonOpts }
  });
}

/********************** Modals **********************/
const modal=document.getElementById('modal');
const modalTitle=document.getElementById('modalTitle');
const modalContent=document.getElementById('modalContent');
document.getElementById('modalClose').onclick=()=>modal.classList.remove('open');
modal.addEventListener('click',e=>{ if (e.target===modal) modal.classList.remove('open'); });
function openModal(title,html){ modalTitle.textContent=title; modalContent.innerHTML=html; modal.classList.add('open'); }

async function showHeadlines({company}){
  const d=document.getElementById('dateSelect').value;
  openModal(`Headlines ‚Äî ${esc(company)}`, `<div class="muted">Loading‚Ä¶</div>`);
  let rows=[];
  try{
    if (_modalHeadlinesCache.has(d)) {
      rows = _modalHeadlinesCache.get(d);
    } else {
      rows = await fetchCsv(HEADLINES_PATH(d));
      _modalHeadlinesCache.set(d, rows);
    }
  }catch(e){
    openModal(`Headlines ‚Äî ${esc(company)}`, `<div class="muted">Could not load headlines for ${d}.</div>`); return;
  }
  const list=rows.filter(r=>String(r.company||'').trim()===company);
  if (!list.length){ openModal(`Headlines ‚Äî ${esc(company)}`, `<div class="muted">No headlines for ${esc(company)} on ${d}.</div>`); return; }

  const cards=list.map(r=>{
    const url=String(r.url||'').trim();
    let domain=''; try{ domain=new URL(url).hostname.replace(/^www\./,''); }catch{}
    const title=esc(r.title||domain||'(no title)');
    const link=url?`<a class="link" href="${esc(url)}" target="_blank" rel="noopener">${title}</a>`:`<span class="muted">${title}</span>`;
    const sRaw=String(r.sentiment||'').toLowerCase();
    const s=sRaw==='positive'?'positive':(sRaw==='negative'?'negative':'neutral');
    return `<div class="serp-card">
      ${domain?`<div class="serp-domain">${esc(domain)}</div>`:''}
      <div class="serp-title">${link}</div>
      <div class="badges" style="margin-top:8px"><span class="badge ${s}">${s}</span></div>
    </div>`;
  }).join('');

  openModal(`Headlines ‚Äî ${esc(company)}`, `<div class="serp-cards">${cards}</div>`);
}

async function showSerp({company}){
  const d=document.getElementById('dateSelect').value;
  openModal(`SERP ‚Äî ${esc(company)}`, `<div class="muted">Loading‚Ä¶</div>`);
  let rows=[]; try{
    if (_modalSerpCache.has(d)) {
      rows = _modalSerpCache.get(d);
    } else {
      rows = await fetchCsv(SERP_ROWS_PATH(d));
      _modalSerpCache.set(d, rows);
    }
  }
  catch{ openModal(`SERP ‚Äî ${esc(company)}`, `<div class="muted">Could not load SERP file for ${d}.</div>`); return; }
  if (!rows.length){ openModal(`SERP ‚Äî ${esc(company)}`, `<div class="muted">No SERP data found for ${d}.</div>`); return; }

  const canon=s=>String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,' ').trim();
  const wantCo=canon(company);
  const matches=rows.filter(r=>canon(r.company)===wantCo);
  if (!matches.length){ openModal(`SERP ‚Äî ${esc(company)}`, `<div class="muted">No SERPs for ${esc(company)} on ${d}.</div>`); return; }

  const total=matches.length;
  const negCount=matches.filter(r=>String(r.sentiment||'').toLowerCase()==='negative').length;
  const ctrlCount=matches.filter(r=>(/^controlled|true|1$/i).test(String(r.controlled||''))).length;
  const negPct= total ? (negCount/total) : 0;
  const ctrlPct= total ? (ctrlCount/total) : 0;
  const risk=computeRisk(negPct,ctrlPct);

  matches.sort((a,b)=>(+a.position||9999)-(+b.position||9999));
  const cards=matches.map(r=>{
    const url=String(r.url||'').trim();
    let domain=''; try{ domain=new URL(url).hostname.replace(/^www\./,''); }catch{}
    const title=esc(r.title||domain||'(no title)');
    const snippet=esc(r.snippet||'');
    const s=String(r.sentiment||'neutral').toLowerCase();
    const ctrl=(/^controlled|true|1$/i).test(String(r.controlled||''))?'controlled':'uncontrolled';
    const link=url?`<a class="link" href="${esc(url)}" target="_blank" rel="noopener">${title}</a>`:`<span class="muted">${title}</span>`;
    return `<div class="serp-card">
      ${domain?`<div class="serp-domain">${esc(domain)}</div>`:''}
      <div class="serp-title">${link}</div>
      ${snippet?`<div class="serp-snippet">${snippet}</div>`:''}
      <div class="badges"><span class="badge ${s}">${s}</span><span class="badge ${ctrl}">${ctrl}</span></div>
    </div>`;
  }).join('');

  const metrics = `<div class="serp-metrics">
    <b>Negative SERP:</b> ${(negPct*100).toFixed(1)}% &nbsp;|&nbsp;
    <b>Control:</b> ${(ctrlPct*100).toFixed(1)}% &nbsp;|&nbsp;
    <b>Risk:</b> ${esc(risk)}
  </div>`;

  openModal(`SERP ‚Äî ${esc(company)}`, `${metrics}<div class="serp-cards">${cards}</div>`);
}

/********************** Init **********************/
init();
</script>
</body>
</html>
